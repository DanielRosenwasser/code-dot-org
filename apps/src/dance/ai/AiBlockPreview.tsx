import {BlockSvg, Workspace, WorkspaceSvg} from 'blockly';
import React, {useEffect, useRef} from 'react';
import moduleStyles from './ai-block-preview.module.scss';

interface AiBlockPreviewProps {
  generateBlocksFromResult: (workspace: Workspace) => [BlockSvg, BlockSvg];
}

/**
 * Previews the blocks generated by the AI block in Dance Party.
 */
const AiBlockPreview: React.FunctionComponent<AiBlockPreviewProps> = ({
  generateBlocksFromResult,
}) => {
  const blockPreviewContainerRef = useRef<HTMLSpanElement>(null);
  const refTimer = useRef<number | null>(null);

  // Build out the blocks.
  useEffect(() => {
    const emptyBlockXml = Blockly.utils.xml.textToDom('<xml></xml>');
    const previewWorkspace: Workspace =
      Blockly.BlockSpace.createReadOnlyBlockSpace(
        blockPreviewContainerRef.current,
        emptyBlockXml,
        {}
      );

    const blocksSvg = generateBlocksFromResult(previewWorkspace);
    blocksSvg.forEach((blockSvg: BlockSvg) => {
      blockSvg.initSvg();
      blockSvg.render();
    });
    Blockly.svgResize(previewWorkspace as WorkspaceSvg);

    return () => {
      previewWorkspace.dispose();
    };
  }, [blockPreviewContainerRef, generateBlocksFromResult]);

  return (
    <span ref={blockPreviewContainerRef} className={moduleStyles.container} />
  );
};

export default AiBlockPreview;
