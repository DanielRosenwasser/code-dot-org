import {BlockSvg, Workspace, WorkspaceSvg} from 'blockly';
import React, {useEffect, useRef} from 'react';
import moduleStyles from './ai-block-preview.module.scss';

interface AiPreviewProps {
  generateBlocksFromResponse: (
    workspace: Workspace
  ) => [BlockSvg, BlockSvg, BlockSvg];
}

/**
 * Previews the blocks generated by the AI block in Dance Party.
 */
const AiBlockPreview: React.FunctionComponent<AiPreviewProps> = ({
  generateBlocksFromResponse,
}) => {
  const blockPreviewContainerRef = useRef<HTMLSpanElement>(null);

  useEffect(() => {
    if (blockPreviewContainerRef.current) {
      const emptyBlockXml = Blockly.utils.xml.textToDom('<xml></xml>');
      const previewWorkspace: Workspace =
        Blockly.BlockSpace.createReadOnlyBlockSpace(
          blockPreviewContainerRef.current,
          emptyBlockXml,
          {}
        );

      const blocksSvg = generateBlocksFromResponse(previewWorkspace);

      blocksSvg.forEach((blockSvg: BlockSvg) => {
        blockSvg.initSvg();
        blockSvg.render();
      });
      Blockly.svgResize(previewWorkspace as WorkspaceSvg);
    }
  }, [blockPreviewContainerRef, generateBlocksFromResponse]);

  return (
    <span ref={blockPreviewContainerRef} className={moduleStyles.container} />
  );
};

export default AiBlockPreview;
